---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Navbar from '../../components/navbar';
import Footer from '../../components/footer';
import { motion } from 'framer-motion';
import { getAllLeads, getBookings } from '../../lib/db';

export const prerender = false;

const db = (Astro.locals as any).runtime?.env?.DB || (Astro.locals as any).env?.DB;
let leads = [];
let bookings = [];

if (db) {
  try {
    leads = await getAllLeads(db);
    bookings = await getBookings(db);
  } catch (error) {
    console.error("Admin DB Error:", error);
    // Fallback to empty or mock will happen naturally if assignments fail
  }
}

// Fallback Mock Data if DB failed or missing
if (leads.length === 0) {
  leads = [
    { id: 1, name: "Jessica Smith", service_type: "Premium Portrait", created_at: new Date().toISOString(), status: "new", priority_score: 85, oracle_insight: "High value potential." },
    { id: 2, name: "Michael Chen", service_type: "Commercial Product", created_at: new Date(Date.now() - 3600000).toISOString(), status: "contacted", priority_score: 45 },
  ];
}

const recentLeads = leads.slice(0, 5).map(l => ({
  id: l.id,
  name: l.name,
  service: l.service_type || 'General',
  date: new Date(l.created_at).toLocaleString('th-TH', { hour: '2-digit', minute: '2-digit' }),
  status: l.status.charAt(0).toUpperCase() + l.status.slice(1),
  priority: l.priority_score || 0
}));

const highPriorityCount = leads.filter(l => (l.priority_score || 0) > 80).length;
const oracleTopInsight = leads.sort((a, b) => (b.priority_score || 0) - (a.priority_score || 0))[0]?.oracle_insight || "Most leads are coming in between 7 PM - 10 PM. You might want to run your next campaign during these hours.";

const stats = [
  { label: "Total Leads", value: leads.length.toString(), change: "+12%" },
  { label: "High Priority (AI)", value: highPriorityCount.toString(), change: "Urgent" },
  { label: "Active Bookings", value: bookings.length.toString(), change: "+5" },
];
---

<BaseLayout 
  title="Admin Dashboard | ClubsxAI"
  description="ClubsxAI Command Center"
>
  <Navbar client:load />

  <main class="min-h-screen pt-24 bg-black text-white p-6">
    <div class="container mx-auto">
      <header class="mb-12">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-white to-white/40 bg-clip-text text-transparent">
          Command Center ðŸ”±
        </h1>
        <p class="text-zinc-500 mt-2">Welcome back, Bo. Here's your business at a glance.</p>
      </header>

      <!-- Stats Grid -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
        {stats.map(stat => (
          <div class="glass-card p-6 rounded-3xl border border-white/10 hover:border-[#FF6B35]/30 transition-colors">
            <p class="text-zinc-500 text-sm">{stat.label}</p>
            <div class="flex items-end justify-between mt-2">
              <span class="text-3xl font-bold font-serif">{stat.value}</span>
              <span class="text-[#FF6B35] text-xs font-medium bg-[#FF6B35]/10 px-2 py-1 rounded-full">
                {stat.change}
              </span>
            </div>
          </div>
        ))}
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Recent Leads -->
        <div class="lg:col-span-2 glass-card rounded-3xl border border-white/10 overflow-hidden">
          <div class="p-6 border-b border-white/5 flex justify-between items-center">
            <h2 class="font-bold text-xl">Recent Leads</h2>
            <a href="/admin/leads" class="text-[#FF6B35] text-sm hover:underline">View All</a>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead>
                <tr class="text-zinc-500 text-xs uppercase tracking-widest bg-white/5">
                  <th class="px-6 py-4">Client</th>
                  <th class="px-6 py-4">Service</th>
                  <th class="px-6 py-4">Received</th>
                  <th class="px-6 py-4">Status</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-white/5">
                {recentLeads.map(lead => (
                  <tr class="hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4 font-medium">{lead.name}</td>
                    <td class="px-6 py-4 text-zinc-400">{lead.service}</td>
                    <td class="px-6 py-4 text-zinc-500 text-sm">{lead.date}</td>
                    <td class="px-6 py-4">
                      <span class={`px-2 py-1 rounded-full text-[10px] font-bold uppercase ${
                        lead.status === 'New' ? 'bg-[#FF6B35] text-black' : 'bg-white/10 text-white/50'
                      }`}>
                        {lead.status}
                      </span>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="space-y-6">
          <div class="glass-card p-6 rounded-3xl border border-white/10">
            <h2 class="font-bold text-xl mb-4">Quick Actions</h2>
            <div class="space-y-3">
              <button class="w-full py-3 px-4 rounded-xl bg-white text-black font-bold hover:bg-zinc-200 transition-colors text-sm">
                Create New Invoice
              </button>
              <button class="w-full py-3 px-4 rounded-xl border border-white/10 hover:bg-white/5 transition-colors text-sm">
                Schedule Session
              </button>
              <button class="w-full py-3 px-4 rounded-xl border border-white/10 hover:bg-white/5 transition-colors text-sm">
                Export Data (CSV)
              </button>
            </div>
          </div>

          <div class="glass-card p-6 rounded-3xl border border-white/10 bg-[#FF6B35]/5 shadow-[0_0_20px_rgba(255,107,53,0.1)]">
            <h2 class="font-bold text-lg mb-2 text-[#FF6B35] flex items-center gap-2">
                <span class="animate-pulse">ðŸ”®</span> Oracle Insights
            </h2>
            <p class="text-zinc-400 text-sm italic leading-relaxed">
              "{oracleTopInsight}"
            </p>
            <div class="mt-4 pt-4 border-t border-white/5 flex items-center justify-between text-[10px] text-zinc-500 uppercase tracking-widest">
                <span>AI Recommendation</span>
                <span class="text-[#FF6B35]">Active</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <Footer client:load />
</BaseLayout>
